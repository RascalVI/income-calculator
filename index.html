<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор дохода 2025 — рабочая версия</title>
  <!-- Flatpickr для выбора диапазона дат -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  <style>
    *{box-sizing:border-box;font-family:"Century Gothic",Arial,sans-serif}
    body{margin:0;padding:40px;background:#f5f6f7;display:flex;justify-content:center}
    .card{width:1100px;background:#fff;border-radius:14px;padding:40px 48px;box-shadow:0 8px 32px rgba(0,0,0,.06)}
    h1{margin:0 0 28px;font-size:34px;font-weight:700}
    label{display:block;margin-bottom:6px;font-weight:600;font-size:15px}
    input,select{padding:12px 14px;font-size:15px;border:1px solid #cfd2d4;border-radius:8px;background:#fff;outline:none;color:#000;width:100%}
    input::placeholder{color:#a8a8a8}
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}
    select{appearance:none;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23666' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 14px center/10px 6px;color:#000}
    .row{display:flex;gap:24px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    .grades-row{display:flex;gap:24px;margin-bottom:16px}
    .grades-row .col{flex:1 0 160px}
    #yearGrade{background:#e9ecef;border:1px solid #cfd2d4;border-radius:8px;padding:12px;text-align:left;white-space:nowrap;overflow:hidden}
    #yrNote{font-size:12px;color:#666;margin-top:4px;text-align:center}
    #yrNoteRes{font-size:12px;color:#666;margin-top:4px;text-align:center}
    .toggle{margin:24px 0 16px;display:flex;align-items:center;gap:4px}
    input[type=checkbox]{width:auto;margin-right:8px}
    .cards{display:flex;gap:16px;flex-wrap:wrap;margin:20px 0}
    .summary-card{flex:1 1 150px;padding:14px 18px;background:#f0f3f5;border-radius:10px;text-align:center}
    .summary-card h3{margin:0;font-size:14px;font-weight:600;color:#555}
    .summary-card p{margin:6px 0 0;font-size:18px;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px}
    th,td{padding:4px 6px;text-align:right;border:1px solid #e1e4e8}
    th{background:#f0f3f5;font-weight:700}
    th.small{width:45px}
    td:first-child,th:first-child{text-align:left}
    .wrap{white-space:normal}
    .tax13 td{background:#fff}.tax15 td{background:#d4f4d4}.tax18 td{background:#fff8b4}.tax20 td{background:#d2ecff}.tax22 td{background:#eadaff}
    .note{font-size:12px;color:#666;margin-top:6px}
    summary{cursor:pointer;font-weight:600}
    /* Список отпусков */
    .vacation-block { 
      display: flex;
      flex-direction: column;
      margin: 16px 0;
      width: 100%;
    }
    #vacList {
      list-style: none;
      padding: 0;
      margin: 0 0 8px 0;
      max-width: 300px;
    }
    #vacList li {
      background: #f0f3f5;
      border-radius: 6px;
      padding: 6px 10px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    #vacList .actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #vacList button {
      border: none;
      background: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #vacList .delete-btn {
      color: #d33;
      font-size: 14px;
    }
    #vacList .edit-btn {
      color: #666;
      font-size: 14px;
    }
    #vacList .edit-btn:hover {
      color: #2680eb;
    }
    /* Центрирование календаря */
    .flatpickr-calendar { position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; }
    /* Стили для праздничных дней */
    .holiday, .flatpickr-day.weekend { color: #ff0000 !important; }
    .flatpickr-day.holiday:hover, .flatpickr-day.weekend:hover { background: #ffe6e6; }
    .flatpickr-day.selected.holiday, .flatpickr-day.selected.weekend { background: #2680eb; color: white !important; }
    /* Стили для существующих отпусков */
    .flatpickr-day.existing-vacation { 
      background: #e6ffe6 !important;
      border-color: #b3ffb3 !important;
    }
    .flatpickr-day.existing-vacation:hover {
      background: #ccffcc !important;
    }
    /* Стили для начала и конца периода отпуска */
    .flatpickr-day.existing-vacation.vacation-start:not(.weekend):not(.holiday),
    .flatpickr-day.existing-vacation.vacation-end:not(.weekend):not(.holiday) {
      color: #000 !important;
    }
    /* Сохраняем красный цвет для выходных и праздников */
    .flatpickr-day.existing-vacation.vacation-start.weekend,
    .flatpickr-day.existing-vacation.vacation-end.weekend,
    .flatpickr-day.existing-vacation.vacation-start.holiday,
    .flatpickr-day.existing-vacation.vacation-end.holiday {
      color: #ff0000 !important;
    }
    /* Стили для кнопки добавления отпуска */
    #addVacation {
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      background: #2067D9;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      width: fit-content;
      align-self: flex-start;
    }
    #addVacation:hover {
      background: #1756bc;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(32, 103, 217, 0.2);
    }
    .info-text {
      font-size: 12px;
      color: #666;
      margin: 8px 0 16px;
      line-height: 1.4;
    }
    .info-text p {
      margin: 4px 0;
    }
    /* Для спорной годовой оценки */
    .year-grade-cell {
      position: relative;
      width: 100%;
      min-width: 0;
    }
    .year-grade-cell.active,
    .year-grade-cell.inactive {
      display: flex;
      align-items: center;
      min-height: unset;
      height: 43px;
      border-radius: 8px;
      padding: 0;
      width: 100%;
      box-sizing: border-box;
    }
    .year-grade-cell.active {
      background: #fff;
      border: 1px solid #cfd2d4;
    }
    .year-grade-cell.inactive {
      background: #e9ecef;
      border: 1px solid #cfd2d4;
    }
    .year-grade-cell select.year-grade-select {
      border: none;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23666' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 14px center/10px 6px;
      font-size: 15px;
      font-weight: 400;
      width: 100%;
      outline: none;
      appearance: none;
      padding: 12px 38px 12px 16px;
      cursor: pointer;
      border-radius: 8px;
      height: 43px;
      box-sizing: border-box;
    }
    .year-grade-cell input[readonly] {
      border: none;
      background: transparent;
      font-size: 15px;
      font-weight: 400;
      width: 100%;
      padding: 12px 16px;
      color: #222;
      text-align: left;
      height: 43px;
      border-radius: 8px;
      box-sizing: border-box;
    }
    .toggle label { display: inline; margin-bottom: 0; }
  </style>
</head>
<body>
<div class="card">
<h1>Калькулятор дохода (2025)</h1>
<div class="row" style="margin-bottom:12px;">
  <div class="col"><label>Целевой годовой совокупный доход<br><span class="note" style="font-size:12px;color:#666;vertical-align:middle;">(₽, до вычета НДФЛ)</span></label><input id="targetInput" type="text" placeholder="1 400 000"></div>
  <div class="col"><label>Целевой ежемесячный совокупный доход <span class="note" style="font-size:12px;color:#666;vertical-align:middle;">(₽, до вычета НДФЛ)</span></label><input id="monthlyTargetInput" type="text" placeholder="116 667"></div>
  <div class="col"><label>Категория распределения дохода <span class="note" style="font-size:12px;color:#666;vertical-align:middle;"> <br>(База / Кв. премия / Год. премия)</span></label>
    <select id="distribution">
      <option value="100/0/0">100/0/0</option>
      <option value="90/10/0">90/10/0</option>
      <option value="90/0/10">90/0/10</option>
      <option value="80/10/10">80/10/10</option>
      <option value="70/20/10">70/20/10</option>
      <option value="60/20/20">60/20/20</option>
      <option value="50/20/30">50/20/30</option>
    </select>
  </div>
</div>
<!-- Оценки -->
<h2 style="margin: 24px 0 8px 0; font-size: 22px; font-weight: 700;">Целевое распределение дохода с учетом квартальных оценок </h2>
<div style="margin-bottom:8px;font-size:15px;font-weight:600;">Оценка корпоративных компетенций</div>
<div class="grades-row">
  <template id="opt"><option value="1.3">A (1.3)</option><option value="1.15">B (1.15)</option><option value="1" selected>C (1)</option><option value="0.75">D (0.75)</option><option value="0">E (0)</option></template>
  <div class="col"><label>I кв.</label><select class="grade" id="g1"></select></div>
  <div class="col"><label>II кв.</label><select class="grade" id="g2"></select></div>
  <div class="col"><label>III кв.</label><select class="grade" id="g3"></select></div>
  <div class="col"><label>IV кв.</label><select class="grade" id="g4"></select></div>
  <div class="col" style="align-self:flex-end;"><label>Годовая оценка</label><div id="yearGradeCell" class="year-grade-cell inactive"><input id="yearGrade" readonly></div><div id="yrNote" class="note"></div></div>
</div>
<div class="toggle"><input type="checkbox" id="addResultGrades"><label for="addResultGrades">Добавить оценку результативности</label></div>
<div id="resultGradesBlock" style="display:none; margin-bottom: 12px;">
  <div style="margin-bottom:8px;font-size:15px;font-weight:600;">Оценки результативности</div>
  <div class="grades-row">
    <div class="col"><label>I кв.</label><select class="grade-res" id="r1"></select></div>
    <div class="col"><label>II кв.</label><select class="grade-res" id="r2"></select></div>
    <div class="col"><label>III кв.</label><select class="grade-res" id="r3"></select></div>
    <div class="col"><label>IV кв.</label><select class="grade-res" id="r4"></select></div>
    <div class="col" style="align-self:flex-end;"><label>Годовая оценка</label><div id="yearGradeResCell" class="year-grade-cell inactive"><input id="yearGradeRes" readonly></div><div id="yrNoteRes" class="note"></div></div>
  </div>
</div>
<div class="cards" id="cards"></div>
<div style="font-size:19px;font-weight:600;">Итого за год (до вычета НДФЛ) <span id="totVal">0 ₽</span><span id="star" style="display:none">*</span></div>
<p class="note" id="taxInfo"></p>
<p class="note"><em>Совокупный доход = База × 12 + Квартальная премия × 4 + Годовая премия</em></p>
<p class="note" id="calcNote"></p>
<details>
  <summary>Учёт праздников, отпусков и дополнительных выплат</summary>
  <div class="info-text">
    <p>НДФЛ: при превышении порога строка месяца меняет цвет (13 → 15 → 18 → 20 → 22 %).</p>
    <p>Доп. выплаты: заполняется сумма разовых премий и компенсационных выплат (при наличии). Учитывается в графе "Итого (после вычета НДФЛ), ₽"</p>
    <p><strong style="color: #d33;">Внимание!</strong> Расчёт отпускных ведётся по совокупному доходу (оклад, премии, надбавки и т.п.) за прошлый период; представленные суммы отпускных соответствуют выбранному совокупному доходу и не учитывают совокупный доход за прошлый расчетный период. Все расчеты носят только ознакомительный характер</p>
  </div>
  <!-- Блок отпусков -->
  <div class="vacation-block">
    <ul id="vacList"></ul>
    <button id="addVacation">+ Добавить оплач. отпуск</button>
  </div>
  <div class="table-wrap">
    <table id="tbl"><thead><tr><th>Месяц</th><th class="small">Норма дней</th><th class="wrap">Оплач.<br>отпуск</th><th class="wrap">Неопл.<br>отпуск</th><th class="wrap">Стоимость<br>дня, ₽</th><th>Базовая часть, ₽</th><th class="wrap">Кварт. премия, ₽</th><th class="wrap">Год. премия, ₽</th><th class="wrap">Итого<br>(до вычета НДФЛ), ₽</th><th>НДФЛ, ₽</th><th class="wrap">Доп. выплаты<br>(после вычета НДФЛ), ₽</th><th class="wrap">Итого (после вычета НДФЛ), ₽</th></tr></thead><tbody></tbody><tfoot><tr><td colspan="11" style="text-align:right;font-weight:700">Фактически за год (после вычета НДФЛ), ₽:</td><td id="fact">0</td></tr></tfoot></table>
  </div>
</details>
</div>
<script>
  /* ---------- Данные праздников 2025 ---------- */
  const holidays2025 = [
    // Январь
    '2025-01-01', '2025-01-02', '2025-01-03', '2025-01-04', 
    '2025-01-05', '2025-01-06', '2025-01-07', '2025-01-08',
    // Май
    '2025-05-01', '2025-05-02', '2025-05-08', '2025-05-09',
    // Июнь
    '2025-06-12', '2025-06-13',
    // Ноябрь
    '2025-11-03', '2025-11-04',
    // Декабрь
    '2025-12-31'
  ];

  /* ---------- Элементы ---------- */
  const targetInput=document.getElementById('targetInput');
  const monthlyTargetInput=document.getElementById('monthlyTargetInput');
  const distribution=document.getElementById('distribution');
  const yearGrade=document.getElementById('yearGrade');
  const yrNote=document.getElementById('yrNote');
  const yearGradeRes=document.getElementById('yearGradeRes');
  const yrNoteRes=document.getElementById('yrNoteRes');
  const addResultGrades=document.getElementById('addResultGrades');
  const resultGradesBlock=document.getElementById('resultGradesBlock');
  const cards=document.getElementById('cards');
  const totVal=document.getElementById('totVal');
  const taxInfo=document.getElementById('taxInfo');
  const fact=document.getElementById('fact');
  const addVacationBtn=document.getElementById('addVacation');
  const vacList=document.getElementById('vacList');

  /* ---------- Константы расчёта ---------- */
  const months=['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
  const norms=[17,20,21,22,18,19,23,21,22,23,19,22];
  const steps=[{lim:2400000,rate:13,cls:'tax13',info:'К сумме будет применяется НДФЛ 13 % до 2,4 млн'},{lim:5000000,rate:15,cls:'tax15',info:'К сумме будет применяется НДФЛ 13 % до 2,4 млн, 15 % до 5 млн'},{lim:20000000,rate:18,cls:'tax18',info:'К сумме будет применяется НДФЛ 13 % до 2,4 млн, 15 % до 5 млн, 18 % до 20 млн'},{lim:50000000,rate:20,cls:'tax20',info:'К сумме будет применяется НДФЛ 13 % до 2,4 млн, 15 % до 5 млн, 18 % до 20 млн, 20 % до 50 млн'},{lim:Infinity,rate:22,cls:'tax22',info:'К сумме будет применяется НДФЛ 13 % до 2,4 млн, 15 % до 5 млн, 18 % до 20 млн, 20 % до 50 млн, 22 % свыше 50 млн'}];
  const coeffMap={1.3:'A',1.15:'B',1:'C',0.75:'D',0:'E'};

  /* ---------- Строим таблицу ---------- */
  const tbody=document.querySelector('#tbl tbody');
  const paid=[],unpaid=[],extra=[],totGrossArr=[],totNetArr=[];
  months.forEach((m,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m}</td><td>${norms[i]}</td><td class='pCell'></td><td><input type='number' class='u' min='0' max='${norms[i]}' value='0'></td><td class='d'></td><td class='b'></td><td class='q'></td><td class='y'></td><td class='totGross'></td><td class='t'></td><td><input type='text' class='x' value='0'></td><td class='totNet'></td>`;
    tbody.appendChild(tr);
    paid.push(tr.querySelector('.pCell'));
    unpaid.push(tr.querySelector('.u'));
    extra.push(tr.querySelector('.x'));
    totGrossArr.push(tr.querySelector('.totGross'));
    totNetArr.push(tr.querySelector('.totNet'));
  });

  /* ---------- Оценки ---------- */
  const gradeEls=[g1,g2,g3,g4];
  gradeEls.forEach(sel=>{sel.appendChild(document.getElementById('opt').content.cloneNode(true));});
  // Оценки результативности
  const gradeResEls = [r1, r2, r3, r4];
  gradeResEls.forEach(sel=>{sel.appendChild(document.getElementById('opt').content.cloneNode(true));});

  /* ---------- Хранилище отпусков ---------- */
  let vacations=[]; // элементы {from:Date,to:Date}

  function dateISO(d){return d.toISOString().split('T')[0];}
  function* eachDay(from,to){for(let d=new Date(from);d<=to;d.setDate(d.getDate()+1))yield new Date(d);}

  // Пересчёт оплачиваемых отпусков по месяцам
  function updateVacations(){
    // нулируем значения
    const monthCounts = new Array(12).fill(0);
    // Сортируем отпуска перед обработкой
    vacations.sort((a, b) => a.from.getTime() - b.from.getTime());
    
    vacations.forEach(({from, to}) => {
      for(const d of eachDay(new Date(from), new Date(to))) {
        // Проверяем, является ли день рабочим (пн-пт, не праздник)
        if (!isHoliday(d) && !isWeekend(d)) {
          monthCounts[d.getMonth()]++;
        }
      }
    });
    
    monthCounts.forEach((cnt, i) => {
      paid[i].textContent = cnt;
    });
    recalc();
  }

  // Добавление/удаление периодов
  const fpInput=document.createElement('input');
  addVacationBtn.addEventListener('click',()=>{
    const fp = flatpickr(fpInput,{
      locale:'ru',
      mode:'range',
      dateFormat:'d.m.Y',
      // Добавляем опцию для отключения очистки выбора
      allowInput: false,
      clickOpens: true,
      onDayCreate: function(dObj, dStr, fp, dayElem) {
        const date = dayElem.dateObj;
        // Проверяем, входит ли дата в существующие периоды отпусков
        const currentDate = date.getTime();
        vacations.forEach(v => {
          if (currentDate >= v.from.getTime() && currentDate <= v.to.getTime()) {
            dayElem.classList.add('existing-vacation');
            // Добавляем классы для начала и конца периода
            if (currentDate === v.from.getTime()) {
              dayElem.classList.add('vacation-start');
            }
            if (currentDate === v.to.getTime()) {
              dayElem.classList.add('vacation-end');
            }
          }
        });
        
        if (isHoliday(date)) {
          dayElem.classList.add('holiday');
        }
        if (isWeekend(date) && !isHoliday(date)) {
          dayElem.classList.add('weekend');
        }
      },
      onChange: function(selectedDates) {
        if (selectedDates.length === 2) {
          let workDays = 0;
          let totalDays = 0;
          for (const d of eachDay(selectedDates[0], selectedDates[1])) {
            totalDays++;
            if (!isHoliday(d) && !isWeekend(d)) {
              workDays++;
            }
          }
          fpInput._fp.altInput.placeholder = `Выберите период (всего ${totalDays} дн., из них ${workDays} раб. дн.)`;
        }
      },
      onClose:(selDates)=>{
        if(selDates.length===2){
          const [from,to]=selDates;
          // Проверяем пересечение с существующими отпусками
          const hasOverlap = vacations.some(v => {
            const newStart = from.getTime();
            const newEnd = to.getTime();
            const existingStart = v.from.getTime();
            const existingEnd = v.to.getTime();
            return (newStart <= existingEnd && newEnd >= existingStart);
          });

          if (hasOverlap) {
            alert('Выбранный период пересекается с уже существующим отпуском. Пожалуйста, выберите другой период.');
            return;
          }

          let workDays = 0;
          let totalDays = 0;
          for (const d of eachDay(from, to)) {
            totalDays++;
            if (!isHoliday(d) && !isWeekend(d)) {
              workDays++;
            }
          }
          vacations.push({from,to,days:workDays,totalDays:totalDays});
          renderVacations();
          updateVacations();
          
          // Обновляем отображение календаря после добавления нового периода
          fp.redraw();
        }
      }
    });
    
    // Открываем календарь
    fp.open();
    
    // Принудительно обновляем отображение после открытия
    setTimeout(() => fp.redraw(), 0);
  });
  function renderVacations(){
    // Сортируем отпуска по дате начала
    vacations.sort((a, b) => a.from.getTime() - b.from.getTime());
    
    vacList.innerHTML='';
    vacations.forEach((v,idx)=>{
      const li=document.createElement('li');
      li.innerHTML=`
        <span>${v.from.toLocaleDateString()} – ${v.to.toLocaleDateString()} (всего ${v.totalDays} дн., из них ${v.days} раб. дн.)</span>
        <div class="actions">
          <button class="edit-btn" title="Редактировать период">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
            </svg>
          </button>
          <button class="delete-btn" title="Удалить период">&times;</button>
        </div>`;

      // Обработчик удаления
      li.querySelector('.delete-btn').onclick=()=>{
        vacations.splice(idx,1);
        renderVacations();
        updateVacations();
      };

      // Обработчик редактирования
      li.querySelector('.edit-btn').onclick=()=>{
        const fp = flatpickr(fpInput,{
          locale:'ru',
          mode:'range',
          dateFormat:'d.m.Y',
          defaultDate: [v.from, v.to],
          allowInput: false,
          clickOpens: true,
          onDayCreate: function(dObj, dStr, fp, dayElem) {
            const date = dayElem.dateObj;
            const currentDate = date.getTime();
            // Показываем все периоды отпусков, кроме редактируемого
            vacations.forEach((vacation, index) => {
              if (index !== idx && 
                  currentDate >= vacation.from.getTime() && 
                  currentDate <= vacation.to.getTime()) {
                dayElem.classList.add('existing-vacation');
                if (currentDate === vacation.from.getTime()) {
                  dayElem.classList.add('vacation-start');
                }
                if (currentDate === vacation.to.getTime()) {
                  dayElem.classList.add('vacation-end');
                }
              }
            });
            
            if (isHoliday(date)) {
              dayElem.classList.add('holiday');
            }
            if (isWeekend(date) && !isHoliday(date)) {
              dayElem.classList.add('weekend');
            }
          },
          onChange: function(selectedDates) {
            if (selectedDates.length === 2) {
              let workDays = 0;
              let totalDays = 0;
              for (const d of eachDay(selectedDates[0], selectedDates[1])) {
                totalDays++;
                if (!isHoliday(d) && !isWeekend(d)) {
                  workDays++;
                }
              }
              fpInput._fp.altInput.placeholder = `Выберите период (всего ${totalDays} дн., из них ${workDays} раб. дн.)`;
            }
          },
          onClose:(selDates)=>{
            if(selDates.length===2){
              const [from,to]=selDates;
              // Проверяем пересечение с существующими отпусками, исключая текущий период
              const hasOverlap = vacations.some((v, i) => {
                if (i === idx) return false;
                const newStart = from.getTime();
                const newEnd = to.getTime();
                const existingStart = v.from.getTime();
                const existingEnd = v.to.getTime();
                return (newStart <= existingEnd && newEnd >= existingStart);
              });

              if (hasOverlap) {
                alert('Выбранный период пересекается с уже существующим отпуском. Пожалуйста, выберите другой период.');
                return;
              }

              let workDays = 0;
              let totalDays = 0;
              for (const d of eachDay(from, to)) {
                totalDays++;
                if (!isHoliday(d) && !isWeekend(d)) {
                  workDays++;
                }
              }
              // Обновляем существующий период
              vacations[idx] = {from,to,days:workDays,totalDays:totalDays};
              renderVacations();
              updateVacations();
            }
            fp.destroy();
          }
        });
        
        fp.open();
        setTimeout(() => fp.redraw(), 0);
      };

      vacList.appendChild(li);
    });
  }

  /* ---------- Форматирование чисел ---------- */
  function formatNumber(number) {
    return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  function parseFormattedNumber(str) {
    return parseInt(str.replace(/\s/g, '')) || 0;
  }

  function syncInputs(sourceInput, targetInput, multiplier) {
    const value = parseFormattedNumber(sourceInput.value);
    targetInput.value = formatNumber(Math.round(value * multiplier));
  }

  targetInput.addEventListener('input', function(e) {
    // Форматируем ввод
    const value = parseFormattedNumber(e.target.value);
    e.target.value = formatNumber(value);
    // Синхронизируем с месячным доходом
    syncInputs(targetInput, monthlyTargetInput, 1/12);
    recalc();
  });

  monthlyTargetInput.addEventListener('input', function(e) {
    // Форматируем ввод
    const value = parseFormattedNumber(e.target.value);
    e.target.value = formatNumber(value);
    // Синхронизируем с годовым доходом
    syncInputs(monthlyTargetInput, targetInput, 12);
    recalc();
  });

  /* ---------- Новый расчет годовой оценки по МР с учетом балльной шкалы ---------- */
  const gradeMap = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
  const gradeLettersByValue = {5:'A',4:'B',3:'C',2:'D',1:'E'};
  const coeffByLetter = { 'A': 1.3, 'B': 1.15, 'C': 1, 'D': 0.75, 'E': 0 };
  const letterByCoeff = { 1.3: 'A', 1.15: 'B', 1: 'C', 0.75: 'D', 0: 'E' };

  function coeffToBall(coeff) {
    // 1.3->5, 1.15->4, 1->3, 0.75->2, 0->1
    if (coeff >= 1.25) return 5;
    if (coeff >= 1.07) return 4;
    if (coeff >= 0.87) return 3;
    if (coeff >= 0.37) return 2;
    return 1;
  }
  function ballToCoeff(ball) {
    return coeffByLetter[gradeLettersByValue[ball]];
  }

  function getGradeByBall(avg) {
    // Возвращает: {letters: ["B"], range: "3,7–4,49"} или {letters: ["B","C"], range: "3,5–3,69"}
    if (avg >= 4.7) return {letters:['A'], range:'≥ 4,7'};
    if (avg >= 4.5) return {letters:['A','B'], range:'4,5–4,69'};
    if (avg >= 3.7) return {letters:['B'], range:'3,7–4,49'};
    if (avg >= 3.5) return {letters:['B','C'], range:'3,5–3,69'};
    if (avg >= 2.7) return {letters:['C'], range:'2,7–3,49'};
    if (avg >= 2.5) return {letters:['C','D'], range:'2,5–2,69'};
    if (avg >= 1.7) return {letters:['D'], range:'1,7–2,49'};
    if (avg >= 1.5) return {letters:['D','E'], range:'1,5–1,69'};
    return {letters:['E'], range:'< 1,5'};
  }

  function renderYearGradeBlock(avg, el, selectId, cellId) {
    // avg — средний балл, el — input для вывода, selectId — id для селекта, cellId — id контейнера
    const cell = document.getElementById(cellId);
    const grade = getGradeByBall(avg);
    // Проверяем, есть ли уже селектор с теми же опциями
    let oldSel = cell.querySelector('select.year-grade-select');
    if (grade.letters.length === 1) {
      cell.className = 'year-grade-cell inactive';
      // Если уже есть input с нужным значением, не пересоздаём
      let oldInput = cell.querySelector('input[readonly]');
      if (oldInput && oldInput.value === grade.letters[0]) return coeffByLetter[grade.letters[0]];
      cell.innerHTML = '';
      const inp = document.createElement('input');
      inp.id = el.id;
      inp.readOnly = true;
      inp.value = grade.letters[0];
      cell.appendChild(inp);
      if (cell.parentElement.querySelector('.note')) cell.parentElement.querySelector('.note').textContent = '';
      return coeffByLetter[grade.letters[0]];
    } else {
      cell.className = 'year-grade-cell active';
      // Проверяем, совпадает ли набор опций
      let needUpdate = true;
      if (oldSel) {
        const opts = Array.from(oldSel.options).map(o=>o.textContent);
        if (opts.length === grade.letters.length && opts.every((o,i)=>o===grade.letters[i])) {
          needUpdate = false;
        }
      }
      if (!oldSel || needUpdate) {
        cell.innerHTML = '';
        const sel = document.createElement('select');
        sel.className = 'year-grade-select';
        sel.id = selectId;
        grade.letters.forEach(letter => {
          const opt = document.createElement('option');
          opt.value = coeffByLetter[letter];
          opt.textContent = letter;
          sel.appendChild(opt);
        });
        cell.appendChild(sel);
        if (cell.parentElement.querySelector('.note')) cell.parentElement.querySelector('.note').textContent = 'По решению руководителя';
        return parseFloat(sel.value);
      } else {
        // Уже есть селектор с нужными опциями, просто возвращаем выбранное значение
        if (cell.parentElement.querySelector('.note')) cell.parentElement.querySelector('.note').textContent = 'По решению руководителя';
        return parseFloat(oldSel.value);
      }
    }
  }

  function calcYearCoef(){
    // Считаем средний балл
    const vals = gradeEls.map(el=>coeffToBall(parseFloat(el.value)));
    const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
    return renderYearGradeBlock(avg, yearGrade, 'yearGradeSelect', 'yearGradeCell');
  }
  function calcYearCoefRes(){
    const vals = gradeResEls.map(el=>coeffToBall(parseFloat(el.value)));
    const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
    return renderYearGradeBlock(avg, yearGradeRes, 'yearGradeResSelect', 'yearGradeResCell');
  }

  // --- Обработка выбора из выпадающего списка итоговой оценки ---
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('year-grade-select')) {
      recalc();
    }
  });

  function getDist(){return distribution.value.split('/').map(Number);}  
  function recalc(){
    const target = parseFormattedNumber(targetInput.value) || parseFormattedNumber(targetInput.placeholder) || 0;
    const [bp, qp, yp] = distribution.value.split('/').map(Number);

    const baseYear = target * bp / 100;
    const baseM = baseYear / 12;
    const quarterPlan = target * qp / 100 / 4;
    const yearPlan = target * yp / 100;
    // --- Получаем коэффициенты ---
    let yCoef = calcYearCoef();
    // Если есть селект, берем выбранное значение
    const selYear = document.getElementById('yearGradeSelect');
    if (selYear) yCoef = parseFloat(selYear.value);
    let yCoefRes = 1;
    let kInt = yCoef;
    if (addResultGrades.checked) {
      yCoefRes = calcYearCoefRes();
      const selRes = document.getElementById('yearGradeResSelect');
      if (selRes) yCoefRes = parseFloat(selRes.value);
      kInt = (yCoef + yCoefRes) / 2;
    }

    // Расчет средней стоимости дня для отпускных
    const totalWorkDays = norms.reduce((a, b) => a + b, 0); // Общее количество рабочих дней в году
    const avgDayRate = target / totalWorkDays; // Средняя стоимость дня для отпускных

    cards.innerHTML='';

    // вспомогательная функция отрисовки карточки
    const makeCard = (title, amt) => {
      const d = document.createElement('div');
      d.className = 'summary-card';
      d.innerHTML = `<h3>${title}</h3><p>${Math.round(amt).toLocaleString('ru-RU')} ₽</p>`;
      cards.appendChild(d);
    };

    let cumulativeGross = 0;

    // Базовая
    makeCard('База / мес.', baseM);

    // Квартальные
    for(let q=0; q<4; q++){
      const coefComp = parseFloat(gradeEls[q].value);
      let coefFinal = coefComp;
      if (addResultGrades.checked) {
        const coefRes = parseFloat(gradeResEls[q].value);
        coefFinal = (coefComp + coefRes) / 2;
      }
      const grossQ = quarterPlan * coefFinal;
      cumulativeGross += grossQ;
      const stepQ = steps.find(s => cumulativeGross <= s.lim);
      const netQ = grossQ * (1 - stepQ.rate/100);
      makeCard(`Q${q+1} премия`, grossQ);
    }

    // Годовая
    let grossY = yearPlan * kInt;
    cumulativeGross += grossY;
    const stepY = steps.find(s => cumulativeGross <= s.lim);
    const netY = grossY * (1 - stepY.rate/100);
    makeCard('Годовая премия', grossY);

    // Таблица и итог
    let cumGross=0, cumNet=0;
    months.forEach((m,i)=>{
      const row = tbody.rows[i];
      row.className='';
      const u = +unpaid[i].value||0;
      const x = parseFormattedNumber(extra[i].value)||0;
      const vacDays = parseInt(paid[i].textContent) || 0;
      // Фактическая стоимость рабочего дня в текущем месяце
      const actualDayRate = baseM / norms[i];
      // Новый расчет отпускных по ТК РФ
      const avgVacationDay = target / 12 / 29.3;
      // Оплата за фактически отработанные дни
      const workDays = norms[i] - vacDays - u;
      const workPay = actualDayRate * workDays;
      // Оплата отпускных по среднему дневному заработку
      const vacationPay = avgVacationDay * vacDays;
      // Базовая часть — только за отработанные дни
      const baseGross = workPay;
      // Отпускные — отдельной строкой
      const vacationGross = vacationPay;
      const idxMap=[3,6,9,11].indexOf(i);
      let qPay=0;
      if(idxMap>=0){
        const coefComp = parseFloat(gradeEls[idxMap].value);
        let coefFinal = coefComp;
        if (addResultGrades.checked) {
          const coefRes = parseFloat(gradeResEls[idxMap].value);
          coefFinal = (coefComp + coefRes) / 2;
        }
        // нормы и отсутствия по кварталу
        const qNorm=norms.slice(idxMap*3,idxMap*3+3).reduce((a,b)=>a+b,0);
        const qAbsentPaid = paid.slice(idxMap*3,idxMap*3+3).reduce((a,td)=>a+(parseInt(td.textContent)||0),0);
        const qAbsentUnpaid = unpaid.slice(idxMap*3,idxMap*3+3).reduce((a,input)=>a+(+input.value||0),0);
        const workCoeff = (qNorm - qAbsentPaid - qAbsentUnpaid) / qNorm;
        qPay = quarterPlan * coefFinal * workCoeff;
      }
      const yPay = i===11 ? grossY : 0;
      // Итоговые начисления: базовая часть + отпускные + премии + доп. выплаты
      const gross = baseGross + vacationGross + qPay + yPay + x;
      cumGross += gross;
      const st = steps.find(s => cumGross <= s.lim);
      const tax = (baseGross + vacationGross + qPay + yPay) * st.rate/100;
      const net = (baseGross + vacationGross + qPay + yPay) - tax;
      cumNet += net + x;
      row.classList.add(st.cls);
      // Стоимость дня
      row.querySelector('.d').textContent = vacDays > 0 ? 
        `${Math.round(actualDayRate).toLocaleString('ru-RU')} (отп: ${Math.round(avgVacationDay).toLocaleString('ru-RU')})` : 
        Math.round(actualDayRate).toLocaleString('ru-RU');
      // Базовая часть
      row.querySelector('.b').textContent = Math.round(baseGross).toLocaleString('ru-RU');
      // Квартальная премия
      row.querySelector('.q').textContent = qPay ? Math.round(qPay).toLocaleString('ru-RU') : '';
      // Годовая премия
      row.querySelector('.y').textContent = yPay ? Math.round(yPay).toLocaleString('ru-RU') : '';
      row.querySelector('.totGross').textContent = Math.round(gross - x).toLocaleString('ru-RU');
      row.querySelector('.t').textContent = Math.round(tax).toLocaleString('ru-RU');
      row.querySelector('.totNet').textContent = Math.round(net + x).toLocaleString('ru-RU');
    });

    const finalVal = cumGross;
    totVal.textContent = Math.round(finalVal).toLocaleString('ru-RU')+' ₽';
    // Пояснение про НДФЛ по итоговой начисленной сумме (cumGross)
    const stepInfo = steps.find(s=>cumGross<=s.lim).info;
    taxInfo.textContent = stepInfo;

    // Итоговая сумма по колонке "Итого (после вычета НДФЛ), ₽"
    let totalNet = 0;
    totNetArr.forEach(cell => {
      const val = parseInt((cell.textContent || '0').replace(/\s/g, '')) || 0;
      totalNet += val;
    });
    fact.textContent = Math.round(totalNet).toLocaleString('ru-RU');

    // Динамическое примечание
    const calcNote = document.getElementById('calcNote');
    if (addResultGrades.checked) {
      calcNote.textContent = 'Итоговая сумма рассчитана исходя из целевого размера совокупного дохода с учетом оценок по корпоративным компетенциям и результативности.';
    } else {
      calcNote.textContent = 'Итоговая сумма рассчитана исходя из целевого размера совокупного дохода с учетом оценок по корпоративным компетенциям.';
    }
  }

  /* ---------- Обработчики ---------- */
  document.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', recalc));
  addResultGrades.addEventListener('change', function() {
    resultGradesBlock.style.display = this.checked ? '' : 'none';
    recalc();
  });

  // Функция для проверки праздничных дней
  function isHoliday(date) {
    // Преобразуем дату в строку в формате YYYY-MM-DD с учетом локального времени
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`;
    return holidays2025.includes(dateStr);
  }

  // Функция для проверки выходных дней
  function isWeekend(date) {
    const day = date.getDay();
    // 1 ноября 2025 - рабочая суббота
    if (date.getFullYear() === 2025 && date.getMonth() === 10 && date.getDate() === 1) {
      return false;
    }
    return day === 0 || day === 6;
  }

  // Форматирование для всех полей .x (доп. выплаты)
  extra.forEach(input => {
    input.addEventListener('input', function(e) {
      const value = parseFormattedNumber(e.target.value);
      e.target.value = formatNumber(value);
      recalc();
    });
  });

  // Инициализация
  recalc();
</script>
</body>
</html>
