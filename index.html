<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор дохода 2025 — рабочая версия</title>
  <!-- Flatpickr для выбора диапазона дат -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  <style>
    *{box-sizing:border-box;font-family:"Century Gothic",Arial,sans-serif}
    body{margin:0;padding:40px;background:#f5f6f7;display:flex;justify-content:center}
    .card{width:1100px;background:#fff;border-radius:14px;padding:40px 48px;box-shadow:0 8px 32px rgba(0,0,0,.06)}
    h1{margin:0 0 28px;font-size:34px;font-weight:700}
    label{display:block;margin-bottom:6px;font-weight:600;font-size:15px}
    input,select{padding:12px 14px;font-size:15px;border:1px solid #cfd2d4;border-radius:8px;background:#fff;outline:none;color:#000;width:100%}
    input::placeholder{color:#a8a8a8}
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}
    select{appearance:none;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23666' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 14px center/10px 6px;color:#000}
    .row{display:flex;gap:24px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    .grades-row{display:flex;gap:24px;margin-bottom:16px}
    .grades-row .col{flex:1 0 160px}
    #yearGrade{background:#e9ecef;border:1px solid #cfd2d4;border-radius:8px;padding:12px;text-align:center;white-space:nowrap;overflow:hidden}
    #yrNote{font-size:12px;color:#a66;margin-top:4px;text-align:center}
    .toggle{margin:24px 0 16px;display:flex;align-items:center;gap:10px}
    input[type=checkbox]{width:auto;margin-right:8px}
    .cards{display:flex;gap:16px;flex-wrap:wrap;margin:20px 0}
    .summary-card{flex:1 1 150px;padding:14px 18px;background:#f0f3f5;border-radius:10px;text-align:center}
    .summary-card h3{margin:0;font-size:14px;font-weight:600;color:#555}
    .summary-card p{margin:6px 0 0;font-size:18px;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px}
    th,td{padding:4px 6px;text-align:right;border:1px solid #e1e4e8}
    th{background:#f0f3f5;font-weight:700}
    th.small{width:45px}
    td:first-child,th:first-child{text-align:left}
    .wrap{white-space:normal}
    .tax13 td{background:#fff}.tax15 td{background:#d4f4d4}.tax18 td{background:#fff8b4}.tax20 td{background:#d2ecff}.tax22 td{background:#eadaff}
    .note{font-size:12px;color:#666;margin-top:6px}
    summary{cursor:pointer;font-weight:600}
    /* Список отпусков */
    #vacList{list-style:none;padding:0;margin:8px 0 0 0;max-width:300px}
    #vacList li{background:#f0f3f5;border-radius:6px;padding:6px 10px;margin-top:6px;display:flex;justify-content:space-between;align-items:center;font-size:13px}
    #vacList button{border:none;background:none;color:#d33;font-size:14px;cursor:pointer}
    /* Центрирование календаря */
    .flatpickr-calendar { position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; }
    /* Стили для праздничных дней */
    .holiday, .flatpickr-day.weekend { color: #ff0000 !important; }
    .flatpickr-day.holiday:hover, .flatpickr-day.weekend:hover { background: #ffe6e6; }
    .flatpickr-day.selected.holiday, .flatpickr-day.selected.weekend { background: #2680eb; color: white !important; }
  </style>
</head>
<body>
<div class="card">
<h1>Калькулятор дохода (2025)</h1>
<div class="row" style="margin-bottom:12px;">
  <div class="col"><label>Целевой годовой совокупный доход (₽, до НДФЛ)</label><input id="targetInput" type="number" step="1000" placeholder="1 400 000"></div>
  <div class="col"><label>Категория распределения дохода <span class="note" style="font-size:12px;color:#666;vertical-align:middle;">(База / Кв. премия / Год. премия)</span></label>
    <select id="distribution">
      <option value="90/0/10" selected>90/0/10</option><option value="80/10/10">80/10/10</option><option value="70/20/10">70/20/10</option><option value="50/20/30">50/20/30</option><option value="100/0/0">100/0/0</option>
    </select>
  </div>
</div>
<!-- Оценки -->
<div style="margin-bottom:8px;font-size:15px;font-weight:600;">Результат оценки корпоративных компетенций</div>
<div class="grades-row">
  <template id="opt"><option value="1.3">A (1.3)</option><option value="1.15">B (1.15)</option><option value="1" selected>C (1)</option><option value="0.75">D (0.75)</option><option value="0">E (0)</option></template>
  <div class="col"><label>I кв.</label><select class="grade" id="g1"></select></div>
  <div class="col"><label>II кв.</label><select class="grade" id="g2"></select></div>
  <div class="col"><label>III кв.</label><select class="grade" id="g3"></select></div>
  <div class="col"><label>IV кв.</label><select class="grade" id="g4"></select></div>
  <div class="col" style="align-self:flex-end;"><label>Годовая оценка</label><input id="yearGrade" readonly><div id="yrNote" class="note"></div></div>
</div>
<div class="toggle"><input type="checkbox" id="showNet"><label for="showNet">Показать доход «на руки» (после НДФЛ)</label></div>
<div class="cards" id="cards"></div>
<div style="font-size:19px;font-weight:600;">Совокупный доход за год <span id="totVal">0 ₽</span><span id="star" style="display:none">*</span></div>
<p class="note" id="taxInfo"></p>
<p class="note"><em>Совокупный доход = База × 12 + Квартальные премии × 4 + Годовая премия</em></p>
<details>
  <summary>Учёт праздников, отпусков и дополнительных выплат</summary>
  <!-- Блок отпусков -->
<div style="margin:16px 0;">
  <button id="addVacation"
          style="padding:8px 14px;border:1px solid #2680eb;border-radius:6px;
                 background:#2680eb;color:#fff;cursor:pointer;font-size:14px;">
    Добавить опл. отпуск
  </button>
  <ul id="vacList"></ul>
</div>
  <div class="table-wrap">
    <table id="tbl"><thead><tr><th>Месяц</th><th class="small">Норма дней</th><th class="wrap">Оплач.<br>отпуск</th><th class="wrap">Неопл.<br>отпуск</th><th class="wrap">Стоимость<br>дня, ₽</th><th>База, ₽</th><th class="wrap">Кварт.<br>премия, ₽</th><th class="wrap">Год.<br>премия, ₽</th><th>Доп. выплаты, ₽</th><th>НДФЛ, ₽</th><th>Итого, ₽</th></tr></thead><tbody></tbody><tfoot><tr><td colspan="10" style="text-align:right;font-weight:700">Фактически за год, ₽:</td><td id="fact">0</td></tr></tfoot></table>
  </div>
</details>
</div>
<script>
  /* ---------- Данные праздников 2025 ---------- */
  const holidays2025 = [
    // Январь
    '2025-01-01', '2025-01-02', '2025-01-03', '2025-01-04', 
    '2025-01-05', '2025-01-06', '2025-01-07', '2025-01-08',
    // Май
    '2025-05-01', '2025-05-02', '2025-05-08', '2025-05-09',
    // Июнь
    '2025-06-12', '2025-06-13',
    // Ноябрь
    '2025-11-03', '2025-11-04',
    // Декабрь
    '2025-12-31'
  ];

  /* ---------- Элементы ---------- */
  const targetInput=document.getElementById('targetInput');
  const distribution=document.getElementById('distribution');
  const showNet=document.getElementById('showNet');
  const yearGrade=document.getElementById('yearGrade');
  const yrNote=document.getElementById('yrNote');
  const cards=document.getElementById('cards');
  const totVal=document.getElementById('totVal');
  const taxInfo=document.getElementById('taxInfo');
  const fact=document.getElementById('fact');
  const addVacationBtn=document.getElementById('addVacation');
  const vacList=document.getElementById('vacList');

  /* ---------- Константы расчёта ---------- */
  const months=['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
  const norms=[17,20,21,22,18,19,23,21,22,23,19,22];
  const steps=[{lim:2400000,rate:13,cls:'tax13',info:'13 % до 2,4 млн'},{lim:5000000,rate:15,cls:'tax15',info:'15 % до 5 млн'},{lim:20000000,rate:18,cls:'tax18',info:'18 % до 20 млн'},{lim:50000000,rate:20,cls:'tax20',info:'20 % до 50 млн'},{lim:Infinity,rate:22,cls:'tax22',info:'22 % свыше 50 млн'}];
  const coeffMap={1.3:'A',1.15:'B',1:'C',0.75:'D',0:'E'};

  /* ---------- Строим таблицу ---------- */
  const tbody=document.querySelector('#tbl tbody');
  const paid=[],unpaid=[],extra=[];
  months.forEach((m,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m}</td><td>${norms[i]}</td><td class='pCell'></td><td><input type='number' class='u' min='0' max='${norms[i]}' value='0'></td><td class='d'></td><td class='b'></td><td class='q'></td><td class='y'></td><td><input type='number' class='x' value='0'></td><td class='t'></td><td class='tot'></td>`;
    tbody.appendChild(tr);
    paid.push(tr.querySelector('.pCell')); // теперь это td, заполняем скриптом
    unpaid.push(tr.querySelector('.u'));
    extra.push(tr.querySelector('.x'));
  });

  /* ---------- Оценки ---------- */
  const gradeEls=[g1,g2,g3,g4];
  gradeEls.forEach(sel=>{sel.appendChild(document.getElementById('opt').content.cloneNode(true));});

  /* ---------- Хранилище отпусков ---------- */
  let vacations=[]; // элементы {from:Date,to:Date}

  function dateISO(d){return d.toISOString().split('T')[0];}
  function* eachDay(from,to){for(let d=new Date(from);d<=to;d.setDate(d.getDate()+1))yield new Date(d);}

  // Пересчёт оплачиваемых отпусков по месяцам
  function updateVacations(){
    // нулируем значения
    const monthCounts=new Array(12).fill(0);
    vacations.forEach(({from,to})=>{
      for(const d of eachDay(new Date(from),new Date(to))){
        const iso=dateISO(d);
        if(!holidays2025.includes(iso)){ monthCounts[d.getMonth()]++; }
      }
    });
    monthCounts.forEach((cnt,i)=>{paid[i].textContent=cnt;});
    recalc();
  }

  // Добавление/удаление периодов
  const fpInput=document.createElement('input');
  addVacationBtn.addEventListener('click',()=>{
    flatpickr(fpInput,{
      locale:'ru',
      mode:'range',
      dateFormat:'d.m.Y',
      onDayCreate: function(dObj, dStr, fp, dayElem) {
        const date = dayElem.dateObj;
        if (isHoliday(date)) {
          dayElem.classList.add('holiday');
        }
        if (isWeekend(date) && !isHoliday(date)) {
          dayElem.classList.add('weekend');
        }
      },
      onChange: function(selectedDates) {
        if (selectedDates.length === 2) {
          let workDays = 0;
          let totalDays = 0;
          for (const d of eachDay(selectedDates[0], selectedDates[1])) {
            totalDays++;
            if (!isHoliday(d) && !isWeekend(d)) {
              workDays++;
            }
          }
          fpInput._fp.altInput.placeholder = `Выберите период (всего ${totalDays} дн., из них ${workDays} раб. дн.)`;
        }
      },
      onClose:(selDates)=>{
        if(selDates.length===2){
          const [from,to]=selDates;
          let workDays = 0;
          let totalDays = 0;
          for (const d of eachDay(from, to)) {
            totalDays++;
            if (!isHoliday(d) && !isWeekend(d)) {
              workDays++;
            }
          }
          vacations.push({from,to,days:workDays,totalDays:totalDays});
          renderVacations();
          updateVacations();
        }
      }
    }).open();
  });
  function renderVacations(){
    vacList.innerHTML='';
    vacations.forEach((v,idx)=>{
      const li=document.createElement('li');
      li.innerHTML=`${v.from.toLocaleDateString()} – ${v.to.toLocaleDateString()} (всего ${v.totalDays} дн., из них ${v.days} раб. дн.) <button>&times;</button>`;
      li.querySelector('button').onclick=()=>{vacations.splice(idx,1);renderVacations();updateVacations();};
      vacList.appendChild(li);
    });
  }

  /* ---------- Расчёты дохода (recalc) ---------- */
  function calcYearCoef(){
    const counts={};gradeEls.forEach(el=>{const v=parseFloat(el.value);counts[v]=(counts[v]||0)+1;});
    const e=Object.entries(counts).map(([v,c])=>[parseFloat(v),c]).sort((a,b)=>b[1]-a[1]||b[0]-a[0]);
    const [v1,c1]=e[0],[v2,c2]=e[1]||[null,0];
    if(c1>c2){yearGrade.value=`${coeffMap[v1]} (${v1})`;yrNote.textContent='';return v1;}
    yearGrade.value=`${coeffMap[v2]} (${v2}) или ${coeffMap[v1]} (${v1})`;yrNote.textContent='по решению руководителя';return v1;
  }
  function getDist(){return distribution.value.split('/').map(Number);}  
  function recalc(){
    const target = parseFloat(targetInput.value.replace(/\s/g,'')) || parseFloat(targetInput.placeholder.replace(/\s/g,'')) || 0;
    const [bp, qp, yp] = distribution.value.split('/').map(Number);

    const baseYear = target * bp / 100;
    const baseM = baseYear / 12;
    const quarterPlan = target * qp / 100 / 4;
    const yearPlan = target * yp / 100;
    const yCoef = calcYearCoef();

    cards.innerHTML='';

    // вспомогательная функция отрисовки карточки
    const makeCard = (title, amt) => {
      const d = document.createElement('div');
      d.className = 'summary-card';
      d.innerHTML = `<h3>${title}</h3><p>${Math.round(amt).toLocaleString('ru-RU')} ₽</p>`;
      cards.appendChild(d);
    };

    let cumulativeGross = 0;

    // Базовая
    makeCard('База / мес.', showNet.checked
      ? baseM * (1 - 0.13)
      : baseM
    );

    // Квартальные
    for(let q=0; q<4; q++){
      const coef = parseFloat(gradeEls[q].value);
      const grossQ = quarterPlan * coef;
      cumulativeGross += grossQ;
      const stepQ = steps.find(s => cumulativeGross <= s.lim);
      const netQ = grossQ * (1 - stepQ.rate/100);
      makeCard(`Q${q+1} премия`, showNet.checked ? netQ : grossQ);
    }

    // Годовая
    const grossY = yearPlan * yCoef;
    cumulativeGross += grossY;
    const stepY = steps.find(s => cumulativeGross <= s.lim);
    const netY = grossY * (1 - stepY.rate/100);
    makeCard('Годовая премия', showNet.checked ? netY : grossY);

    // Таблица и итог
    let cumGross=0, cumNet=0;
    months.forEach((m,i)=>{
      const row = tbody.rows[i];
      row.className='';
      const u = +unpaid[i].value||0;
      const x = +extra[i].value||0;
      const dayCost = baseM / norms[i];
      const baseGross = baseM - u*dayCost;
      const idxMap=[3,6,9,11].indexOf(i);
      let qPay=0;
      if(idxMap>=0){
        const coef=parseFloat(gradeEls[idxMap].value);
        // нормы и отсутствия по кварталу
        const qNorm=norms.slice(idxMap*3,idxMap*3+3).reduce((a,b)=>a+b,0);
        const qAbsentPaid = paid.slice(idxMap*3,idxMap*3+3).reduce((a,td)=>a+(parseInt(td.textContent)||0),0);
        const qAbsentUnpaid = unpaid.slice(idxMap*3,idxMap*3+3).reduce((a,input)=>a+(+input.value||0),0);
        const workCoeff = (qNorm - qAbsentPaid - qAbsentUnpaid) / qNorm;
        qPay = quarterPlan * coef * workCoeff;
      }
      const yPay = i===11 ? grossY : 0;
      const gross = baseGross + qPay + yPay + x; baseGross + qPay + yPay + x;
      cumGross += gross;
      const st = steps.find(s => cumGross <= s.lim);
      const tax = gross * st.rate/100;
      const net = gross - tax;
      cumNet += net;

      row.classList.add(st.cls);
      row.querySelector('.d').textContent = Math.round(dayCost).toLocaleString('ru-RU');
      row.querySelector('.b').textContent = Math.round(showNet.checked ? baseGross*(1-st.rate/100) : baseGross).toLocaleString('ru-RU');
      row.querySelector('.q').textContent = qPay ? Math.round(showNet.checked ? qPay*(1-st.rate/100) : qPay).toLocaleString('ru-RU') : '';
      row.querySelector('.y').textContent = yPay ? Math.round(showNet.checked ? yPay*(1-st.rate/100) : yPay).toLocaleString('ru-RU') : '';
      row.querySelector('.t').textContent = Math.round(tax).toLocaleString('ru-RU');
      row.querySelector('.tot').textContent = Math.round(showNet.checked ? net : gross).toLocaleString('ru-RU');
    });

    const finalVal = showNet.checked ? cumNet : cumGross;
    totVal.textContent = Math.round(finalVal).toLocaleString('ru-RU')+' ₽';
    taxInfo.textContent = showNet.checked ? '' : steps.find(s=>cumGross<=s.lim).info;
    fact.textContent = Math.round(finalVal).toLocaleString('ru-RU');
  }

  /* ---------- Обработчики ---------- */
  document.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', recalc));
  showNet.addEventListener('change', recalc);

  // Функция для проверки праздничных дней
  function isHoliday(date) {
    // Преобразуем дату в строку в формате YYYY-MM-DD с учетом локального времени
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`;
    return holidays2025.includes(dateStr);
  }

  // Функция для проверки выходных дней
  function isWeekend(date) {
    const day = date.getDay();
    // 1 ноября 2025 - рабочая суббота
    if (date.getFullYear() === 2025 && date.getMonth() === 10 && date.getDate() === 1) {
      return false;
    }
    return day === 0 || day === 6;
  }

  // Инициализация
  recalc();
</script>
</body>
</html>
